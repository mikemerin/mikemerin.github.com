<!DOCTYPE html>
<html>
  <head>
    <title>Using ActiveRecord and SQL for Big Data – Learning Code with Mike Merin – I'm a meteorologist-turned-programmer. You can find my projects and blog here.</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="What should you do when building an application that requires you to scrape a large amount of data? The answer is as big as the data.

" />
    <meta property="og:description" content="What should you do when building an application that requires you to scrape a large amount of data? The answer is as big as the data.

" />
    
    <meta name="author" content="Learning Code with Mike Merin" />

    
    <meta property="og:title" content="Using ActiveRecord and SQL for Big Data" />
    <meta property="twitter:title" content="Using ActiveRecord and SQL for Big Data" />
    


    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Learning Code with Mike Merin - I'm a meteorologist-turned-programmer. You can find my projects and blog here." href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars1.githubusercontent.com/u/25751785?v=3&u=911668ca8f138c635755deeab510034ca325d624&s=400" /></a>

          <div class="site-info">
            <h1 class="site-name"><a class="showLink" href="/">Learning Code with Mike Merin</a></h1>
            <p class="site-description">I'm a meteorologist-turned-programmer. You can find my projects and blog here.</p>
          </div>

          <nav><div class="icons">
<a href="mailto:Mike.D.Merin@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://github.com/mikemerin"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/mike-merin"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/mikemerin"><i class="svg-icon twitter"></i></a>


</div></nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Using ActiveRecord and SQL for Big Data</h1>
  <h3>WeatherCraft blog part 1: how to scrape data quickly</h3>

  <div class="entry">
    <p>What should you do when building an application that requires you to scrape a large amount of data? The answer is as big as the data.</p>

<p>In my <a href="https://github.com/mikemerin/WeatherCraftAPI">first project</a> concerning big data I had a lot to learn especially from an efficiency standpoint. I’ve scraped data before and have created my own databases but nothing on this large of a scale. The files I downloaded totaled 60 gigabytes, yes 60, and that’s pure text. How much text do you ask? One of the files was 600MB, had 50 columns of data, and 4.6 million rows. That was just one of 125 similar files between 400MB and 600MB big, and I needed to be able to scrape all that data within a short amount of time. My initial script would have taken around <strong>5.6 months</strong> to finish scraping that much data. By then end I got this down to <strong>1.4 days</strong>, around <strong>120 times faster</strong>. So how did I fix it? Here’s my journey:</p>

<h1 id="phase-0---generating-activerecord-resources">Phase 0 - Generating ActiveRecord Resources</h1>
<h3 id="pre-scraping">(pre-scraping)</h3>
<hr />
<p>My project involved past weather data over a course of 10 years, including weather station data, monthly breakdowns, daily breakdowns, and hourly breakdowns. When you work with large amounts of data you want to start off small and then scale it up once it works. My station data was only 223KB so I started with that.</p>

<p>Let’s take a look at a small section of that station data:</p>

<table>
  <thead>
    <tr>
      <th>WBAN</th>
      <th>WMO</th>
      <th>CallSign</th>
      <th>ClimateDivisionCode</th>
      <th>ClimateDivisionStateCode</th>
      <th>ClimateDivisionStationCode</th>
      <th>Name</th>
      <th>State</th>
      <th>Location</th>
      <th>Latitude</th>
      <th>Longitude</th>
      <th>GroundHeight</th>
      <th>StationHeight</th>
      <th>Barometer</th>
      <th>TimeZone</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>14732</td>
      <td>72503</td>
      <td>LGA</td>
      <td>04</td>
      <td>30</td>
      <td>5811</td>
      <td>NEW YORK</td>
      <td>NY</td>
      <td>LA GUARDIA AIRPORT</td>
      <td>40.7792</td>
      <td>-73.88</td>
      <td>11</td>
      <td>31</td>
      <td>39</td>
      <td>-5</td>
    </tr>
    <tr>
      <td>23234</td>
      <td>72494</td>
      <td>SFO</td>
      <td>04</td>
      <td>04</td>
      <td>7769</td>
      <td>SAN FRANCISCO</td>
      <td>CA</td>
      <td>SAN FRANCISCO INTERNATIONAL AIRPORT</td>
      <td>37.6197</td>
      <td>-122.3647</td>
      <td>8</td>
      <td>18</td>
      <td>89</td>
      <td>-8</td>
    </tr>
    <tr>
      <td>93738</td>
      <td>72403</td>
      <td>IAD</td>
      <td>04</td>
      <td>44</td>
      <td>8903</td>
      <td>WASHINGTON</td>
      <td>VA</td>
      <td>WASHINGTON DULLES INTERNATIONAL AP</td>
      <td>38.9349</td>
      <td>-77.4473</td>
      <td>290</td>
      <td>323</td>
      <td>309</td>
      <td>-5</td>
    </tr>
    <tr>
      <td>94728</td>
      <td>72506</td>
      <td>NYC</td>
      <td>04</td>
      <td>30</td>
      <td>5801</td>
      <td>NEW YORK</td>
      <td>NY</td>
      <td>CENTRAL PARK</td>
      <td>40.7889</td>
      <td>-73.9669</td>
      <td>130</td>
      <td>156</td>
      <td>161</td>
      <td>-5</td>
    </tr>
    <tr>
      <td>94789</td>
      <td>74486</td>
      <td>JFK</td>
      <td>04</td>
      <td>30</td>
      <td>5803</td>
      <td>NEW YORK</td>
      <td>NY</td>
      <td>JOHN F KENNEDY INTERNATIONAL AIRPORT</td>
      <td>40.6386</td>
      <td>-73.7622</td>
      <td>11</td>
      <td>22</td>
      <td>32</td>
      <td>-5</td>
    </tr>
    <tr>
      <td>94823</td>
      <td>72520</td>
      <td>PIT</td>
      <td>09</td>
      <td>36</td>
      <td>6993</td>
      <td>PITTSBURGH</td>
      <td>PA</td>
      <td>PITTSBURGH INTERNATIONAL AIRPORT</td>
      <td>40.4846</td>
      <td>-80.2144</td>
      <td>1203</td>
      <td>1203</td>
      <td>1175</td>
      <td>-5</td>
    </tr>
  </tbody>
</table>

<p>That’s already quite a few columns, and I don’t need to use all of them. When I generated my <code class="language-plaintext highlighter-rouge">station</code> model I used a Rails generator:</p>

<p><code class="language-plaintext highlighter-rouge">rails g resource station wban name callsign state location latitude longitude groundHeight stationHeight</code></p>

<p>Which created a <code class="language-plaintext highlighter-rouge">/db/migrate/[20170626211645]_create_stations.rb</code> file that looked like</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CreateStations</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span><span class="p">[</span><span class="mf">5.1</span><span class="p">]</span>
  <span class="k">def</span> <span class="nf">change</span>
    <span class="n">create_table</span> <span class="ss">:stations</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:wban</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:name</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:callsign</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:state</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:location</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:latitude</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:longitude</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:groundHeight</span>
      <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="ss">:stationHeight</span>

      <span class="n">t</span><span class="p">.</span><span class="nf">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>And I made my stations_controller, which controls the RESTful conventions. Here’s just the create and strong params used:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">StationsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@station</span> <span class="o">=</span> <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">station_params</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">station_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:station</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span>
        <span class="ss">:wban</span><span class="p">,</span>
        <span class="ss">:name</span><span class="p">,</span>
        <span class="ss">:callsign</span><span class="p">,</span>
        <span class="ss">:state</span><span class="p">,</span>
        <span class="ss">:location</span><span class="p">,</span>
        <span class="ss">:latitude</span><span class="p">,</span>
        <span class="ss">:longitude</span><span class="p">,</span>
        <span class="ss">:groundHeight</span><span class="p">,</span>
        <span class="ss">:stationHeight</span>
        <span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p>Finally to prevent duplicate data I added this to my Station model:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Station</span> <span class="o">&lt;</span> <span class="no">ApplicationRecord</span>
  <span class="n">validates</span> <span class="ss">:wban</span><span class="p">,</span> <span class="ss">presence: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">uniqueness: </span><span class="kp">true</span>
<span class="k">end</span>

</code></pre></div></div>

<p>So with that in mind I went to creating the scraper!</p>

<h1 id="phase-1---how-to-scrape">Phase 1 - How to Scrape</h1>

<p>I figured I could tap into the RESTful routes script and create a new database row using the create method:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="n">station</span> <span class="o">=</span> <span class="no">Station</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">wban: </span><span class="s2">"94728"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"NEW YORK"</span><span class="p">,</span> <span class="ss">callsign: </span><span class="s2">"NYC"</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
  <span class="n">station</span><span class="p">.</span><span class="nf">save</span>
<span class="k">end</span>

<span class="c1"># or simply</span>

<span class="k">def</span> <span class="nf">create</span>
  <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="s2">"94728"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"NEW YORK"</span><span class="p">,</span> <span class="ss">callsign: </span><span class="s2">"NYC"</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If you’re in a rails console you can create a new database entry this way if you have the correct parameters, and then test it out by calling on our <code class="language-plaintext highlighter-rouge">Station</code> table</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Station</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">count</span> <span class="c1">#=&gt; 0</span>
<span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="s2">"94728"</span><span class="p">,</span> <span class="ss">name: </span><span class="s2">"NEW YORK"</span><span class="p">,</span> <span class="ss">callsign: </span><span class="s2">"NYC"</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
<span class="no">Station</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">count</span> <span class="c1">#=&gt; 1</span>
<span class="no">Station</span><span class="p">.</span><span class="nf">first</span> <span class="c1">#=&gt; &lt;Station id: 1, wban: "94728", name: "NEW YORK", callsign: "NYC", ... &gt;</span>
</code></pre></div></div>

<p>So looking at the data above, how can we call on it? First we need the file path. You can either get the URL path, or like me if you downloaded the text file, you can get the file path by dragging the physical file into your terminal. To use that file we type in:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span> <span class="o">=</span> <span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span>
<span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
<span class="c1">#=&gt; &lt;Enumerator: File:foreach("/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt")&gt;</span>
</code></pre></div></div>
<p>Now that it’s an enumerator we can start pulling information from it!</p>

<p>I know I listed the data above as a table, but from a raw data standpoint it looks like this:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>WBAN|WMO|CallSign|ClimateDivisionCode|ClimateDivisionStateCode|ClimateDivisionStationCode|Name|State|Location|Latitude|Longitude|GroundHeight|StationHeight|Barometer|TimeZone
14732|72503|LGA|04|30|5811|NEW YORK|NY|LA GUARDIA AIRPORT|40.7792|-73.88|11|31|39|-5
23234|72494|SFO|04|04|7769|SAN FRANCISCO|CA|SAN FRANCISCO INTERNATIONAL AIRPORT|37.6197|-122.3647|8|18|89|-8
93738|72403|IAD|04|44|8903|WASHINGTON|VA|WASHINGTON DULLES INTERNATIONAL AP|38.9349|-77.4473|290|323|309|-5
94728|72506|NYC|04|30|5801|NEW YORK|NY|CENTRAL PARK|40.7889|-73.9669|130|156|161|-5
94789|74486|JFK|04|30|5803|NEW YORK|NY|JOHN F KENNEDY INTERNATIONAL AIRPORT|40.6386|-73.7622|11|22|32|-5
94823|72520|PIT|09|36|6993|PITTSBURGH|PA|PITTSBURGH INTERNATIONAL AIRPORT|40.4846|-80.2144|1203|1203|1175|-5
94846|72530|ORD|02|11|1549|CHICAGO|IL|CHICAGO O’HARE INTERNATIONAL AIRPORT|41.995|-87.9336|662|674|658|-6
</code></pre></div></div>

<p>While from a human standpoint we’d call this ugly, this is what we call in the coding business: perfect. The data is cleanly separated by a pipe <code class="language-plaintext highlighter-rouge">\</code> which will make separating out the data a breeze. Sometimes they’re unfortunately separated by commonly used punctuation like a comma or a dash, in that case you’d have to use regular expressions to prevent errors (like <code class="language-plaintext highlighter-rouge">(^|,)</code> if data is separated by commas and there are commas in the actual column data). We can split up a row’s data by using <code class="language-plaintext highlighter-rouge">split("|")</code>. If we used our enumerator for iteration we’d get:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span> <span class="o">=</span> <span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span>
<span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

  <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>
  <span class="n">split_row</span> <span class="c1">#=&gt; header ["WBAN", "WMO", "CallSign", "ClimateDivisionCode", "ClimateDivisionStateCode", ... ]</span>
  <span class="n">split_row</span> <span class="c1">#=&gt; next   ["14732", "72503", "LGA", "04", "30", "5811", "NEW YORK", "NY", ... ]</span>

<span class="k">end</span>
</code></pre></div></div>
<p>Now that we have our columns neatly split up, we can assign them to their variables:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wban</span> <span class="o">=</span> <span class="n">split_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">wmo</span> <span class="o">=</span> <span class="n">split_row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">callsign</span> <span class="o">=</span> <span class="n">split_row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="n">climateDivisionCode</span> <span class="o">=</span> <span class="n">split_row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
<span class="o">...</span>
</code></pre></div></div>

<p>That’ll get tiring real fast, so let’s just use mass assignment instead:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="o">...</span> <span class="o">=</span> <span class="n">split_row</span>
</code></pre></div></div>

<p>And finally we’ll create a Station from those variables using the RESTful script from before, assigning only the values we want to take from it:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="o">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Bringing it all together:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span> <span class="o">=</span> <span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span>
<span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

  <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>
  <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
  <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span><span class="p">)</span>

<span class="k">end</span>
</code></pre></div></div>

<p>However the first line is the header (<code class="language-plaintext highlighter-rouge">WBAN|WMO|CallSign</code>) and we don’t want that added into the database. We’ll just add a line that says “ignore the first line”</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">file</span> <span class="o">=</span> <span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span>
<span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

  <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
    <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
    <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span>
</code></pre></div></div>

<p>Voila, a scraper that works!</p>

<h1 id="phase-2---rakefile-and-benchmarks">Phase 2 - Rakefile and Benchmarks</h1>
<hr />

<p>Although the scraper works it’s still a hassle to have to either open up the rails console and paste it in, or put it in our normal files to call on, so why don’t we use a <code class="language-plaintext highlighter-rouge">rake</code> command that will do it for us? After all we have <code class="language-plaintext highlighter-rouge">rake db:drop</code> to drop tables, <code class="language-plaintext highlighter-rouge">rake db:migrate</code> to migrate our tables, and so on, let’s just make something called <code class="language-plaintext highlighter-rouge">rake data:scrape_stations</code> that will let us do it just as easily!</p>

<p>Let’s first make our script into a method called <code class="language-plaintext highlighter-rouge">scrape_stations</code>, which will let us use the script easily as well as call from different files:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

    <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
      <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
      <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span><span class="p">)</span>
<span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt"</span><span class="p">)</span>
</code></pre></div></div>

<p>Then in our <code class="language-plaintext highlighter-rouge">Rakefile</code> we’ll add the following</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">namespace</span> <span class="ss">:data</span> <span class="k">do</span>

  <span class="n">desc</span> <span class="s2">"scrape stations"</span>
  <span class="n">task</span> <span class="ss">:scrape_stations</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span><span class="p">)</span>
    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now we can call <code class="language-plaintext highlighter-rouge">rake data:scrape_stations</code> in the terminal and it will perform our scraping method! Let’s take it one step further though and add some timestamps to our code so we can see how long it will take for us to perform our tasks using <code class="language-plaintext highlighter-rouge">Time.now</code> to log the time:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
    <span class="k">unless</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"|"</span>
      <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
        <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
        <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="n">namespace</span> <span class="ss">:data</span> <span class="k">do</span>

  <span class="n">desc</span> <span class="s2">"scrape stations"</span>
  <span class="n">task</span> <span class="ss">:scrape_stations</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Migration starting at </span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">"</span>

    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span><span class="p">)</span>
    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt"</span><span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>

    <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Migration ended at </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2"> and took </span><span class="si">#{</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="si">}</span><span class="s2"> minutes </span><span class="si">#{</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="si">}</span><span class="s2"> seconds)."</span>
    <span class="nb">puts</span> <span class="s2">"There are now </span><span class="si">#{</span><span class="no">Station</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> stations."</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This will output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Migration starting at 2017-06-28 22:56:58 <span class="nt">-0400</span>

Migration ended at 2017-06-28 22:57:26 <span class="nt">-0400</span> and took 0.4614648833333333 minutes 27.687893 seconds<span class="o">)</span><span class="nb">.</span>
There are now 2837 stations.
</code></pre></div></div>

<p>Not bad, but we can go even further. After all we only see the start and end times, not actually seeing the progress in between. Let’s modify our method to:</p>

<ol>
  <li>take in the time for us to keep track of</li>
  <li>add a counter that goes up each time an entry is added</li>
  <li>output a notification for every 500 entries, including the time</li>
</ol>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> migration starting at </span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"---------"</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

    <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
      <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
      <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">t</span><span class="si">}</span><span class="s2"> s: </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> entries added"</span> <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">end</span>

  <span class="nb">puts</span> <span class="s2">"---------"</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> total entries added."</span>

<span class="k">end</span>

<span class="c1"># Rakefile</span>

<span class="n">namespace</span> <span class="ss">:data</span> <span class="k">do</span>

  <span class="n">desc</span> <span class="s2">"scrape stations"</span>
  <span class="n">task</span> <span class="ss">:scrape_stations</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="n">t</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>

    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt"</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
    <span class="n">scrape_stations</span><span class="p">(</span><span class="s2">"/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt"</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="n">t2</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">Migration ended at </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2"> and took </span><span class="si">#{</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span><span class="si">}</span><span class="s2"> minutes </span><span class="si">#{</span><span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">%</span> <span class="mi">60</span><span class="si">}</span><span class="s2"> seconds)."</span>
    <span class="nb">puts</span> <span class="s2">"There are now </span><span class="si">#{</span><span class="no">Station</span><span class="p">.</span><span class="nf">all</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> stations."</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<p>This now outputs much more information and also makes the process of scraping not as boring as we can see some movement on the screen every once in a while.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt migration starting at 2017-06-28 23:02:48 <span class="nt">-0400</span>
<span class="nt">---------</span>
3.771182 s: 500 entries added
7.477357 s: 1000 entries added
11.520816 s: 1500 entries added
15.643081 s: 2000 entries added
19.623183 s: 2500 entries added
<span class="nt">---------</span>
2559 total entries added.

/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt migration starting at 2017-06-28 23:02:48 <span class="nt">-0400</span>
<span class="nt">---------</span>
21.234295 s: 500 entries added
22.577552 s: 1000 entries added
24.129251 s: 1500 entries added
25.467219 s: 2000 entries added
<span class="nt">---------</span>
2280 total entries added.

Migration ended at 2017-06-28 23:03:15 <span class="nt">-0400</span> and took 0.44117138333333333 minutes 26.470283 seconds<span class="o">)</span><span class="nb">.</span>
There are now 2837 stations.
</code></pre></div></div>

<p>By the way the reason why you see 2,559 stations and then 2,280 stations added from the different files but only 2,837 total stations in the end added is because of the validation I have in my model of <code class="language-plaintext highlighter-rouge">validates :wban, presence: true, uniqueness: true</code> which prevents duplicate stations from being added, looking at the <code class="language-plaintext highlighter-rouge">wban</code> column to make sure. We’ll come back to this later.</p>

<h1 id="phase-3---bulk-creation">Phase 3 - Bulk Creation</h1>

<p>As I said initially, this is one of the smallest of the files I worked with, and it’s still taking 26 seconds to populate our database. Why? Well each time we do <code class="language-plaintext highlighter-rouge">Station.create</code> it fires off a SQL query of:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">stations</span> <span class="p">(</span><span class="n">wban</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="p">...)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>

<p>In the small scale it may only take around .01 seconds every time we send that query from our API to the database, but when we’re dealing with 2,837 different rows that adds up quite a bit. Just imagine what happens when I move to my file with 77,000 rows. I did, and I tried it out (it took 12 minutes). So I went to try and find a way to limit the SQL calls.</p>

<p>After a while of tinkering around, I tried to add all the columns as a hash into an array and then do a single <code class="language-plaintext highlighter-rouge">Station.create(array)</code> from there:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> migration starting at </span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"---------"</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>

    <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
      <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
      <span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="p">{</span> <span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span> <span class="p">}</span>
    <span class="k">end</span>


    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">t</span><span class="si">}</span><span class="s2"> s: </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> entries added"</span> <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">end</span>

  <span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="s2">"---------"</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> total entries added."</span>

<span class="k">end</span>
</code></pre></div></div>

<p>But unfortunately that didn’t work because the program would still look at each individual hash in our <code class="language-plaintext highlighter-rouge">Station.create</code> and fire off SQL for each one.</p>

<p>Fair warning, this is the point in where hours passed by trying to find a way to directly fire off SQL from my Rails script. I’ll save you the time though of the many lines of code in the rails console I tried out, scripts within my Rakefile, and all different tunnels of the internet and stackoverflow and cut to how I finally found the answer.</p>

<h1 id="phase-4---manual-sql">Phase 4 - Manual SQL</h1>

<p>Using SQL in a program like Postgres or SQLite isn’t too bad at its core. We can ideally insert a new entry into our database the way I said before:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">stations</span> <span class="p">(</span><span class="n">wban</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="p">...)</span> <span class="k">VALUES</span> <span class="p">(</span><span class="o">?</span><span class="p">,</span> <span class="o">?</span><span class="p">,</span> <span class="p">...)</span>
</code></pre></div></div>

<p>BUT I kept getting this error:</p>

<p><code class="language-plaintext highlighter-rouge">ActiveRecord::NotNullViolation: SQLite3::ConstraintException: NOT NULL constraint failed:</code></p>

<p>This plagued me for a while since my stations table had a lot of other things going on, including four has_many / belongs_to relationships, full RESTful routes, and more. The answer to this though lied in my schema, specifically these two lines:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">create_table</span> <span class="s2">"stations"</span><span class="p">,</span> <span class="ss">force: :cascade</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"wban"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"name"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"callsign"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"state"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"location"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"latitude"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"longitude"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"groundHeight"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">string</span> <span class="s2">"stationHeight"</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"created_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span> <span class="c1"># &lt;----</span>
  <span class="n">t</span><span class="p">.</span><span class="nf">datetime</span> <span class="s2">"updated_at"</span><span class="p">,</span> <span class="ss">null: </span><span class="kp">false</span> <span class="c1"># &lt;----</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Those <code class="language-plaintext highlighter-rouge">null: false</code> columns were created as timestamps, and I wasn’t including them in my manual SQL script because ActiveRecord usually does that for us. SO, I needed to modify my <code class="language-plaintext highlighter-rouge">INSERT INTO</code> script to include <code class="language-plaintext highlighter-rouge">created_at, updated_at</code> in the column names and have a time added as their values. That was problem 1. Just kidding in my journey that was problem 14 at this point.</p>

<p>In order to get this script to fire in my program I needed to use something called <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.connection.execute(sql)</code> to fire off a custom SQL command. The final product needed to look like this:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">stations</span> <span class="p">(</span><span class="n">wban</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="k">state</span><span class="p">,</span> <span class="k">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span> <span class="nv">"14732"</span><span class="p">,</span> <span class="nv">"72503"</span><span class="p">,</span> <span class="nv">"LGA"</span><span class="p">,</span> <span class="nv">"04"</span><span class="p">,</span> <span class="nv">"30"</span><span class="p">,</span> <span class="nv">"5811"</span><span class="p">,</span> <span class="nv">"NEW YORK"</span><span class="p">,</span> <span class="nv">"NY"</span><span class="p">,</span> <span class="nv">"LA GUARDIA AIRPORT"</span><span class="p">,</span> <span class="nv">"40.7792"</span><span class="p">,</span> <span class="nv">"-73.88"</span><span class="p">,</span> <span class="nv">"11"</span><span class="p">,</span> <span class="nv">"31"</span><span class="p">,</span> <span class="nv">"39"</span><span class="p">,</span> <span class="nv">"-5"</span><span class="p">,</span> <span class="nv">"Time"</span><span class="p">,</span> <span class="nv">"Time"</span> <span class="p">)</span>

<span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">stations</span> <span class="p">(</span><span class="n">wban</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="k">state</span><span class="p">,</span> <span class="k">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span>
<span class="k">VALUES</span> <span class="p">(</span> <span class="nv">"98486"</span><span class="p">,</span> <span class="nv">"72530"</span><span class="p">,</span> <span class="nv">"ORD"</span><span class="p">,</span> <span class="nv">"02"</span><span class="p">,</span> <span class="nv">"11"</span><span class="p">,</span> <span class="nv">"1549"</span><span class="p">,</span> <span class="nv">"CHICAGO"</span><span class="p">,</span> <span class="nv">"IL"</span><span class="p">,</span> <span class="nv">"CHICAGO O'HARE INTERNATIONAL AIRPORT"</span><span class="p">,</span> <span class="p">...</span> <span class="p">)</span>
</code></pre></div></div>

<p>Except that these are individual SQL that fire off, so with the same header we can separate multiple values by a comma:</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">stations</span> <span class="p">(</span><span class="n">wban</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="k">state</span><span class="p">,</span> <span class="k">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">created_at</span><span class="p">,</span> <span class="n">updated_at</span><span class="p">)</span>
<span class="k">VALUES</span>
    <span class="p">(</span> <span class="nv">"14732"</span><span class="p">,</span> <span class="nv">"72503"</span><span class="p">,</span> <span class="nv">"LGA"</span><span class="p">,</span> <span class="nv">"04"</span><span class="p">,</span> <span class="nv">"30"</span><span class="p">,</span> <span class="nv">"5811"</span><span class="p">,</span> <span class="nv">"NEW YORK"</span><span class="p">,</span> <span class="nv">"NY"</span><span class="p">,</span> <span class="nv">"LA GUARDIA AIRPORT"</span><span class="p">,</span> <span class="nv">"40.7792"</span><span class="p">,</span> <span class="nv">"-73.88"</span><span class="p">,</span> <span class="nv">"11"</span><span class="p">,</span> <span class="nv">"31"</span><span class="p">,</span> <span class="nv">"39"</span><span class="p">,</span> <span class="nv">"-5"</span><span class="p">,</span> <span class="nv">"Time"</span><span class="p">,</span> <span class="nv">"Time"</span> <span class="p">),</span>
    <span class="p">(</span> <span class="nv">"98486"</span><span class="p">,</span> <span class="nv">"72530"</span><span class="p">,</span> <span class="nv">"ORD"</span><span class="p">,</span> <span class="nv">"02"</span><span class="p">,</span> <span class="nv">"11"</span><span class="p">,</span> <span class="nv">"1549"</span><span class="p">,</span> <span class="nv">"CHICAGO"</span><span class="p">,</span> <span class="nv">"IL"</span><span class="p">,</span> <span class="nv">"CHICAGO O'HARE INTERNATIONAL AIRPORT"</span><span class="p">,</span> <span class="nv">"41.995"</span><span class="p">,</span> <span class="nv">"-87.9336"</span><span class="p">,</span> <span class="nv">"662"</span><span class="p">,</span> <span class="nv">"674"</span><span class="p">,</span> <span class="nv">"658"</span><span class="p">,</span> <span class="nv">"-6"</span><span class="p">,</span> <span class="nv">"Time"</span><span class="p">,</span> <span class="nv">"Time"</span> <span class="p">)</span>
</code></pre></div></div>

<p>Which fires off just once. Perfect! To get this added dynamically added we can make an array, and each row push in a string that looks the same as what’s above, then join them together by a comma:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO stations (wban, name, ...) VALUES "</span> <span class="o">+</span> <span class="n">array</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</code></pre></div></div>

<p>To actually do this we’ll change this in our existing code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="p">{</span> <span class="ss">wban: </span><span class="n">wban</span><span class="p">,</span> <span class="ss">callsign: </span><span class="n">callsign</span><span class="p">,</span> <span class="ss">name: </span><span class="nb">name</span><span class="p">,</span> <span class="ss">state: </span><span class="n">state</span><span class="p">,</span> <span class="ss">location: </span><span class="n">location</span><span class="p">,</span> <span class="ss">latitude: </span><span class="n">latitude</span><span class="p">,</span> <span class="ss">longitude: </span><span class="n">longitude</span><span class="p">,</span> <span class="ss">groundHeight: </span><span class="n">groundHeight</span><span class="p">,</span> <span class="ss">stationHeight: </span><span class="n">stationHeight</span> <span class="p">}</span>

<span class="c1"># to a string</span>

<span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s2">"('</span><span class="si">#{</span><span class="n">wban</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">latitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">longitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">groundHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">stationHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">')"</span>

<span class="c1"># and our sql firing</span>

<span class="no">Station</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>

<span class="c1"># to our new SQL string</span>

<span class="n">sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO stations (wban, name, callsign, state, location, latitude, longitude, groundHeight, stationHeight, created_at, updated_at) VALUES "</span> <span class="o">+</span> <span class="n">array</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
</code></pre></div></div>

<p>Which put together looks like:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> migration starting at </span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"---------"</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
    <span class="k">unless</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"|"</span>
      <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
        <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
        <span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s2">"('</span><span class="si">#{</span><span class="n">wban</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">latitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">longitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">groundHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">stationHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">')"</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">t</span><span class="si">}</span><span class="s2"> s: </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> entries added"</span> <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">end</span>

  <span class="n">sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO stations (wban, name, callsign, state, location, latitude, longitude, groundHeight, stationHeight, created_at, updated_at) VALUES "</span> <span class="o">+</span> <span class="n">array</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="s2">"---------"</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> total entries added."</span>

<span class="k">end</span>
</code></pre></div></div>

<p>Now we have a script that gathers all of the rows for us then fires off a <strong>single</strong> SQL query which should cut down majorly on time! I’d run the benchmark test to see how long it would take, but there’s a major problem that will prevent this script from even running in the first place in certain commonly occurring conditions…</p>

<h1 id="phase-5---sanitizing-our-data">Phase 5 - Sanitizing Our Data</h1>

<p>This is a major problem that <code class="language-plaintext highlighter-rouge">ActiveRecord</code> took care of for us with <strong>strong params</strong>, which was our <code class="language-plaintext highlighter-rouge">params.require(:station).permit(:wban, :callsign, ...)</code> line in our controller. What does sanitizing that mean?</p>

<p><img src="https://imgs.xkcd.com/comics/exploits_of_a_mom.png" alt="XKCD 237" /></p>

<p>Let’s take a look at our string and the Chicago airport line:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s2">"('</span><span class="si">#{</span><span class="n">wban</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">latitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">longitude</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">groundHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="n">stationHeight</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">', '</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">')"</span>
<span class="c1"># becomes</span>
<span class="s2">"('98486', '72530', 'ORD', '02', '11', '1549', 'CHICAGO', 'IL', 'CHICAGO O'HARE INTERNATIONAL AIRPORT', '41.995', '-87.9336', '662', '674', '658', '-6', '2017-06-29 00:20:32 -0400', '2017-06-29 00:20:32 -0400')"</span>
</code></pre></div></div>

<p>See the problem? If there is a quotation mark <code class="language-plaintext highlighter-rouge">'</code>/<code class="language-plaintext highlighter-rouge">"</code> somewhere, or a colon <code class="language-plaintext highlighter-rouge">:</code> it will break our string, or if there is something malicious by mistake like <code class="language-plaintext highlighter-rouge">DROP TABLE stations</code> somewhere like in the XKCD comic above it would ruin everything. We can’t simply change our outer bounds to a single quote <code class="language-plaintext highlighter-rouge">'</code> instead of double <code class="language-plaintext highlighter-rouge">"</code> because we then can’t interpolate <code class="language-plaintext highlighter-rouge">#{objects}</code>. Rails and ActiveRecord uses strong params to do this, and the answer to our problems is <code class="language-plaintext highlighter-rouge">ActiveRecord::Base.connection.quote('string')</code> that will do this for us! (in older versions this was known as <code class="language-plaintext highlighter-rouge">ActiveRecord::Base:sanitize('string')</code>)</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">string</span> <span class="o">=</span> <span class="s2">"Hey what's up? It's </span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="si">}</span><span class="s2">"</span>
<span class="n">string</span> <span class="c1">#=&gt; "Hey what's up? It's 2017-06-29 09:01:36 -0400"</span>
<span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="c1">#=&gt; "'Hey what''s up? It''s 2017-06-29 09:02:23 -0400'"</span>
</code></pre></div></div>

<p>See how it takes care of the quotes for us? This makes sure we never break our string, and in turn never run something that’s sitting in the broken part of the string (and break our program in the process). We can’t simply sanitize the entire string before we insert it into our array by doing <code class="language-plaintext highlighter-rouge">array &lt;&lt; ActiveRecord::Base.connection.quote("(#{wban}, #{callsign}, #{name}, ...)</code> as it wouldn’t apply to the interpolated objects. We <em>can</em> however sanitize each column in the row before we do our mass assignment:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>
<span class="n">split_row</span><span class="p">.</span><span class="nf">map!</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span>
</code></pre></div></div>

<p>Now each column’s values including ones like “O’HARE” will be able to work. Also we should also sanitize each row’s <code class="language-plaintext highlighter-rouge">time</code> that inserts into our <code class="language-plaintext highlighter-rouge">created_at</code> and <code class="language-plaintext highlighter-rouge">updated_at</code> columns so those colons don’t cause a problem:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
</code></pre></div></div>

<p>Putting this all together:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">scrape_stations</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

  <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="n">array</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> migration starting at </span><span class="si">#{</span><span class="n">t</span><span class="si">}</span><span class="s2">"</span>
  <span class="nb">puts</span> <span class="s2">"---------"</span>

  <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
    <span class="k">unless</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"|"</span>
      <span class="n">split_row</span> <span class="o">=</span> <span class="n">row</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="s2">"|"</span><span class="p">)</span>
      <span class="n">split_row</span><span class="p">.</span><span class="nf">map!</span> <span class="p">{</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">}</span>

      <span class="k">if</span> <span class="n">row</span> <span class="o">!=</span> <span class="no">File</span><span class="p">.</span><span class="nf">foreach</span><span class="p">(</span><span class="n">file</span><span class="p">).</span><span class="nf">first</span>
        <span class="n">wban</span><span class="p">,</span> <span class="n">wmo</span><span class="p">,</span> <span class="n">callsign</span><span class="p">,</span> <span class="n">climateDivisionCode</span><span class="p">,</span> <span class="n">climateDivisionStateCode</span><span class="p">,</span> <span class="n">climateDivisionStationcode</span><span class="p">,</span> <span class="nb">name</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">groundHeight</span><span class="p">,</span> <span class="n">stationHeight</span><span class="p">,</span> <span class="n">barometer</span><span class="p">,</span> <span class="n">timezone</span> <span class="o">=</span> <span class="n">split_row</span>
        <span class="n">time</span> <span class="o">=</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">quote</span><span class="p">(</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">)</span>
        <span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s2">"(</span><span class="si">#{</span><span class="n">wban</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">callsign</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">state</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">location</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">latitude</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">longitude</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">groundHeight</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">stationHeight</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">time</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">time</span><span class="si">}</span><span class="s2">)"</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="no">Time</span><span class="p">.</span><span class="nf">now</span> <span class="o">-</span> <span class="n">t</span><span class="si">}</span><span class="s2"> s: </span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> entries added"</span> <span class="k">if</span> <span class="n">count</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="k">end</span>

  <span class="n">sql</span> <span class="o">=</span> <span class="s2">"INSERT INTO stations (wban, name, callsign, state, location, latitude, longitude, groundHeight, stationHeight, created_at, updated_at) VALUES "</span> <span class="o">+</span> <span class="n">array</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="s2">", "</span><span class="p">)</span>
  <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">connection</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>

  <span class="nb">puts</span> <span class="s2">"---------"</span>
  <span class="nb">puts</span> <span class="s2">"</span><span class="si">#{</span><span class="n">count</span><span class="si">}</span><span class="s2"> total entries added."</span>

<span class="k">end</span>
</code></pre></div></div>
<p>Now for the moment of truth: how much faster are we populating our database? We were previously at:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Migration ended at 2017-06-28 23:03:15 <span class="nt">-0400</span> and took 0.44117138333333333 minutes 26.470283 seconds<span class="o">)</span><span class="nb">.</span>
 There are now 2837 stations.
</code></pre></div></div>

<p>Running our new program we’re at:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/Users/flatironschool/Downloads/QCLCD_Gathered/201706station.txt migration starting at 2017-06-29 00:54:31 <span class="nt">-0400</span>
<span class="nt">---------</span>
0.211752 s: 500 entries added
0.283182 s: 1000 entries added
0.371189 s: 1500 entries added
0.442112 s: 2000 entries added
0.509279 s: 2500 entries added
<span class="nt">---------</span>
2559 total entries added.

/Users/flatironschool/Downloads/QCLCD_Gathered/200705station.txt migration starting at 2017-06-29 00:54:31 <span class="nt">-0400</span>
<span class="nt">---------</span>
0.678407 s: 500 entries added
0.749073 s: 1000 entries added
0.81953 s: 1500 entries added
0.898837 s: 2000 entries added
<span class="nt">---------</span>
2280 total entries added.

Migration ended at 2017-06-29 00:54:32 <span class="nt">-0400</span> and took 0.016682166666666668 minutes 1.00093 seconds<span class="o">)</span><span class="nb">.</span>
There are now 2837 stations.
</code></pre></div></div>

<p>We went from 26 seconds to just <strong>one</strong> second! That’s a 26 times increase and that’s only with 2837 stations.</p>

<h1 id="conclusion-and-big-data-implications">Conclusion, and Big Data Implications</h1>
<hr />
<p>We see the <strong>gigantic</strong> benefit of writing our own SQL and firing off a single query instead. It may only take around .01 seconds to send a request from our API to the database, but with only 3000 queries we’re already taking 30 seconds to run our scraper. If we limit this to one big SQL query we no longer spend time on the back and forth, but on collecting the data into a string and then waiting for the database to render it into rows.</p>

<p>Speaking of which if we look at our final script, the actual Rails part of the script before we even fired off SQL took .5 seconds for the first file and .35 seconds for the second file meaning the SQL firing only took .15 seconds. What does this mean for big data?</p>

<p>I first tried our old individual method with a different file containing 70,000 rows of data and it took 700 seconds, or 11.5 minutes. With the new grouped up method it took only <strong>26 seconds</strong> which is a 2650% increase in efficiency, or 26.5 times faster!</p>

<p>I went even bigger though and tried a file with <strong>4.6 million rows</strong> which took only <strong>13 minutes</strong> to complete. If we assumed a group method takes 26.5 times as long (it would actually be even longer on this larger scale) this would take 344 minutes, or <strong>5 hours 45 minutes</strong> to complete. And by the way this is only 480 MB of the 60 GB of data I need in my project, so per the data:</p>

<table>
  <thead>
    <tr>
      <th>lines</th>
      <th>individual time</th>
      <th>group time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>3000</td>
      <td>26.5 s</td>
      <td>1 s</td>
    </tr>
    <tr>
      <td>70,000</td>
      <td>11.5 m (690 s)</td>
      <td>26 s</td>
    </tr>
    <tr>
      <td>4.6 m</td>
      <td>5 h 45 m (345 m)</td>
      <td>13 m</td>
    </tr>
    <tr>
      <td>575 m</td>
      <td>30 days</td>
      <td>1 day 3 h</td>
    </tr>
  </tbody>
</table>

<p>I choose the latter.</p>

<p>Code on.</p>

<p>Mike Merin</p>

  </div>

  <div class="date">
    Written on June 27, 2017
  </div>

  

</article>

    </div>

    

  </body>
</html>
